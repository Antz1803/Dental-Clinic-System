@model IEnumerable<DCAS.Models.PersonInfo>

@{
    ViewData["Title"] = "Person Info Index";
}
<style>
    .card-header {
  max-width: fit-content;  
  width: auto;  
  padding: 5px 15px;
        background-color: #E5D9D9;
  margin: -15px auto; 
}

.card-header h2 {
  margin: 0;  
  padding: 5px 0;
            color: #B28989;
        }
        .modal-header{
        background-color: #DBCACA;
        color: #B28989;
        }
        .modal-footer{
        background-color: #F6EFEF;
        }
        .btn-button{
        background-color: #DBCACA;
        color:white;
        }
        table{
            margin-top:50px;
        }
        .thead-d th {
        background-color: #F6EFEF;
        color: #B28989;
    }
</style>
    <div class="card">
  <div class="card-header text-black">
                    <h2 class="mb-0">
                        <i class="fas fa-edit"></i> Update Information/Reschedule's
                    </h2>
                </div>
<div class="m-3">
<table class="table table-striped table-bordered table-sm">
    <thead class="thead-d">
        <tr>
            <th>@Html.DisplayNameFor(m => m.First().Name)</th>
            <th>Date Of Visit</th>
            <th>@Html.DisplayNameFor(m => m.First().Age)</th>
            <th>Mobile Number</th>
            <th>@Html.DisplayNameFor(m => m.First().Status)</th>
            <th>Contact Number</th>
            <th>Available Day</th>
            <th>AvailableTime</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@item.Name</td>
                <td>@item.Date?.ToString("yyyy-MM-dd")</td>
                <td>@item.Age</td>
                <td>@item.MobileNumber</td>
                <td>@item.Status</td>
                <td>@item.ContactNumber</td>
                <td>@item.AvailableDay</td>
                        <td>
                            @{
                                // Check if the string is null or empty
                                if (!string.IsNullOrEmpty(item.AvailableTime))
                                {
                                    // Attempt to parse the string into a TimeSpan
                                    if (TimeSpan.TryParse(item.AvailableTime, out TimeSpan timeSpanValue))
                                    {
                                        // Convert the TimeSpan to a displayable DateTime for formatting
                                        var time = DateTime.Today.Add(timeSpanValue);
                                        @time.ToString("h:mm tt")
                                        // Output in 12-hour format (e.g., 4:30 PM)
                                    }
                                }
                            }
                        </td>
                        <td class="text-nowrap">
                            <button type="button" class="open-update-modal btn btn-warning p-0 px-2 rounded-pill" data-id="@item.Id" title="Update Basic Info">Update</button> |
                            <button type="button" class="open-details-modal btn btn-info p-0 px-2 rounded-pill" data-id="@item.Id" title="View Full Details">View Details</button> |
                            <button type="button" class="reschedule-btn btn btn-success p-0 px-2 rounded-pill" data-id="@item.Id" title="Reschedule Appointment">Reschedule</button>
                        </td>
            </tr>
        }
    </tbody>
</table>
</div>
</div>
<!-- Update Modal -->
<div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <form id="updateForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateModalLabel">Update Person Info</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body row g-3">
                    <input type="hidden" id="Id" name="Id" />

                    <div class="col-md-6">
                        <label for="Name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="Name" name="Name" required />
                    </div>
                    <div class="col-md-6">
                        <label for="HomeAddress" class="form-label">Home Address</label>
                        <input type="text" class="form-control" id="HomeAddress" name="HomeAddress" />
                    </div>
                    <div class="col-md-6">
                        <label for="Date" class="form-label">Date Of Visit</label>
                        <input type="date" class="form-control" id="Date" name="Date" readonly/>
                    </div>
                    <div class="col-md-6">
                        <label for="BirthDay" class="form-label">Birthday</label>
                        <input type="date" class="form-control" id="BirthDay" name="BirthDay" />
                    </div>
                    <div class="col-md-6">
                        <label for="Age" class="form-label">Age</label>
                        <input type="number" class="form-control" id="Age" name="Age" />
                    </div>
                    <div class="col-md-6">
                        <label for="HomeNumber" class="form-label">Home Number</label>
                        <input type="text" class="form-control" id="HomeNumber" name="HomeNumber" />
                    </div>
                    <div class="col-md-6">
                        <label for="Occupation" class="form-label">Occupation</label>
                        <input type="text" class="form-control" id="Occupation" name="Occupation" />
                    </div>
                    <div class="col-md-6">
                        <label for="MobileNumber" class="form-label">Mobile Number</label>
                        <input type="text" class="form-control" id="MobileNumber" name="MobileNumber" />
                    </div>
                    <div class="col-md-6">
                        <label for="OfficeAddress" class="form-label">Office Address</label>
                        <input type="text" class="form-control" id="OfficeAddress" name="OfficeAddress" />
                    </div>
                    <div class="col-md-6">
                        <label for="EmailAddress" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="EmailAddress" name="EmailAddress" />
                    </div>
                    <div class="col-md-6">
                        <label for="Status" class="form-label">Status</label>
                        <input type="text" class="form-control" id="Status" name="Status" />
                    </div>
                    <div class="col-md-6">
                        <label for="NameOfSpouse" class="form-label">Name of Spouse</label>
                        <input type="text" class="form-control" id="NameOfSpouse" name="NameOfSpouse" />
                    </div>
                    <div class="col-md-6">
                        <label for="PersonalResponsibleforAccount" class="form-label">Responsible for Account</label>
                        <input type="text" class="form-control" id="PersonalResponsibleforAccount" name="PersonalResponsibleforAccount" />
                    </div>
                    <div class="col-md-6">
                        <label for="Relationship" class="form-label">Relationship</label>
                        <input type="text" class="form-control" id="Relationship" name="Relationship" />
                    </div>
                    <div class="col-md-6">
                        <label for="PhysicianCare" class="form-label">Physician Care</label>
                        <input type="text" class="form-control" id="PhysicianCare" name="PhysicianCare" />
                    </div>
                    <div class="col-md-6">
                        <label for="PhysicianName" class="form-label">Physician Name</label>
                        <input type="text" class="form-control" id="PhysicianName" name="PhysicianName" />
                    </div>
                    <div class="col-md-6">
                        <label for="ContactNumber" class="form-label">Physician Contact Number</label>
                        <input type="text" class="form-control" id="ContactNumber" name="ContactNumber" />
                    </div>
                    <div class="col-md-6">
                        <label for="AvailableDay" class="form-label">Available Day</label>
                        <input type="text" class="form-control" id="AvailableDay" name="AvailableDay" readonly/>
                    </div>
                    <div class="col-md-6">
                        <label for="AvailableTime" class="form-label">Available Time</label>
                        <input type="text" class="form-control" id="AvailableTime" name="AvailableTime" readonly />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-button">Save changes</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Details Modal - Full Person Info -->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Person Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body row g-3">
                <!-- Basic Info -->
                <div class="col-md-6"><strong>Name:</strong> <span id="detailName"></span></div>
                <div class="col-md-6"><strong>Home Address:</strong> <span id="detailHomeAddress"></span></div>
                <div class="col-md-6"><strong>Date Of Visit:</strong> <span id="detailDate"></span></div>
                <div class="col-md-6"><strong>Birthday:</strong> <span id="detailBirthDay"></span></div>
                <div class="col-md-6"><strong>Age:</strong> <span id="detailAge"></span></div>
                <div class="col-md-6"><strong>Home Number:</strong> <span id="detailHomeNumber"></span></div>
                <div class="col-md-6"><strong>Occupation:</strong> <span id="detailOccupation"></span></div>
                <div class="col-md-6"><strong>Mobile Number:</strong> <span id="detailMobileNumber"></span></div>
                <div class="col-md-6"><strong>Office Address:</strong> <span id="detailOfficeAddress"></span></div>
                <div class="col-md-6"><strong>Email Address:</strong> <span id="detailEmailAddress"></span></div>
                <div class="col-md-6"><strong>Status:</strong> <span id="detailStatus"></span></div>
                <div class="col-md-6"><strong>Name of Spouse:</strong> <span id="detailNameOfSpouse"></span></div>
                <div class="col-md-6"><strong>Responsible for Account:</strong> <span id="detailPersonalResponsibleforAccount"></span></div>
                <div class="col-md-6"><strong>Relationship:</strong> <span id="detailRelationship"></span></div>
                <div class="col-md-6"><strong>Physician Care:</strong> <span id="detailPhysicianCare"></span></div>
                <div class="col-md-6"><strong>Physician Name:</strong> <span id="detailPhysicianName"></span></div>
                <div class="col-md-6"><strong>Physician Contact Number:</strong> <span id="detailContactNumber"></span></div>
                <div class="col-md-6"><strong>Available Day:</strong> <span id="detailAvailableDay"></span></div>
                <div class="col-md-6"><strong>Available Time:</strong> <span id="detailAvailableTime"></span></div>

                <!-- Extra Detail Fields -->
                <div class="col-md-6"><strong>How do you preferred to be addressed: </strong> <span id="detailDetailOnee"></span></div>
                <div class="col-md-6"><strong>Whom we may thank for referring you to our clinic: </strong> <span id="detailDetailTwoo"></span></div>
                <div class="col-md-6"><strong>Do you have symptoms: </strong> <span id="detailDetailOne"></span></div>
                <div class="col-md-6"><strong>Are taking any medication, vitamins or supplements?: </strong> <span id="detailDetailTwo"></span></div>
                <div class="col-md-6"><strong>For what purpose: </strong> <span id="detailDetailThree"></span></div>
                <div class="col-md-6"><strong>Are you allergic or sensitive to any food, drug or medications?: </strong> <span id="detailDetailFour"></span></div>
                <div class="col-md-6"><strong>For wowen Only: Are you pregnant?: </strong> <span id="detailDetailFive"></span></div>
                <div class="col-md-6"><strong>Expected Date of Delivery: </strong> <span id="detailDetailSix"></span></div>
                <div class="col-md-6"><strong>Do you have any problems associated with your menstrual period?: </strong> <span id="detailDetailSeven"></span></div>
            </div>

            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

<!-- Update Details Modal -->
<div class="modal fade" id="updateDetailsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form id="updateDetailsForm">
                <div class="modal-header">
                    <h5 class="modal-title">Update Person Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body row g-3">
                    <input type="hidden" id="DetailsId" name="Id" />

                    <div class="col-md-6">
                        <label for="DetailOnee" class="form-label">How do you preferred to be addressed: </label>
                        <input type="text" class="form-control" id="DetailOnee" name="DetailOnee" />
                    </div>
                    <div class="col-md-6">
                        <label for="DetailTwoo" class="form-label">Whom we may thank for referring you to our clinic: </label>
                        <input type="text" class="form-control" id="DetailTwoo" name="DetailTwoo" />
                    </div>
                    <div class="col-md-6">
                        <label for="DetailOne" class="form-label">Do you have symptoms: </label>
                        <input type="text" class="form-control" id="DetailOne" name="DetailOne" />
                    </div>
                    <div class="col-md-6">
                        <label for="DetailTwo" class="form-label">Are taking any medication, vitamins or supplements?: </label>
                        <input type="text" class="form-control" id="DetailTwo" name="DetailTwo" />
                    </div>
                    <div class="col-md-6">
                        <label for="DetailThree" class="form-label">For what purpose: </label>
                        <input type="text" class="form-control" id="DetailThree" name="DetailThree" />
                    </div>
                    <div class="col-md-6">
                        <label for="DetailFour" class="form-label">Are you allergic or sensitive to any food, drug or medications?: </label>
                        <input type="text" class="form-control" id="DetailFour" name="DetailFour" />
                    </div>
                    <div class="col-md-6">
                        <label for="DetailFive" class="form-label">For wowen Only: Are you pregnant?: </label>
                        <input type="text" class="form-control" id="DetailFive" name="DetailFive" />
                    </div>
                    <div class="col-md-6">
                        <label for="DetailSix" class="form-label">Expected Date of Delivery: </label>
                        <input type="text" class="form-control" id="DetailSix" name="DetailSix" />
                    </div>
                    <div class="col-md-6">
                        <label for="DetailSeven" class="form-label">Do you have any problems associated with your menstrual period?: </label>
                        <input type="text" class="form-control" id="DetailSeven" name="DetailSeven" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-button">Save Details</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reschedule Modal -->
<div class="modal fade" id="rescheduleModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reschedule Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reschedulePersonId" />

                <div class="mb-3">
                    <label class="form-label"><strong>Person:</strong></label>
                    <div id="reschedulePersonName"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Available Date</label>
                    <select class="form-select" id="availableDate" required>
                        <option value="">Select date...</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Available Time</label>
                    <select class="form-select" id="availableTime" required disabled>
                        <option value="">Select time...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="confirmReschedule" class="btn btn-button">Reschedule</button>
            </div>
        </div>
    </div>
</div>
<!-- Bootstrap 5 JS (before closing body tag) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<!-- jQuery (if not already included) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

@section Scripts {
    <script>
        $(document).ready(function () {

            // ======================
            // UPDATE MODAL
            // ======================
            $(".open-update-modal").click(function () {
                var id = $(this).data("id");

                $.ajax({
                    url: '@Url.Action("GetById", "Reschedules")',
                    type: 'GET',
                    data: { id: id },
                    success: function (data) {
                        $("#DetailsId").val(data.id || '');
                        $("#DetailOnee").val(data.detailOnee || '');
                        $("#DetailTwoo").val(data.detailTwoo || '');
                        $("#DetailOne").val(data.detailOne || '');
                        $("#DetailTwo").val(data.detailTwo || '');
                        $("#DetailThree").val(data.detailThree || '');
                        $("#DetailFour").val(data.detailFour || '');
                        $("#DetailFive").val(data.detailFive || '');
                        $("#DetailSix").val(data.detailSix || '');
                        $("#DetailSeven").val(data.detailSeven || '');
                        $("#DetailEigth").val(data.detailEigth || '');

                        var updateModal = new bootstrap.Modal(document.getElementById("updateDetailsModal"));
                        updateModal.show();
                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX Error:", status, error, xhr.responseText);
                        alert("Error loading details for update.");
                    }
                });
            });

            // Save updated details
            $("#updateDetailsForm").submit(function (e) {
                e.preventDefault();
                var formData = $(this).serialize();

                $.ajax({
                    url: '@Url.Action("UpdateDetails", "Reschedules")',
                    type: 'POST',
                    data: formData,
                    success: function () {
                        var updateModal = bootstrap.Modal.getInstance(document.getElementById("updateDetailsModal"));
                        updateModal.hide();
                        location.reload();
                    },
                    error: function () {
                        alert("Error saving details.");
                    }
                });
            });

            // ======================
            // DETAILS MODAL
            // ======================
            $(".open-details-modal").click(function () {
                var id = $(this).data("id");

                $.ajax({
                    url: '@Url.Action("GetById", "Reschedules")',
                    type: 'GET',
                    data: { id: id },
                    success: function (data) {
                        $("#detailName").text(data.name);
                        $("#detailHomeAddress").text(data.homeAddress);
                        $("#detailDate").text(data.date);

                        if (data.birthDay) {
                            let birthDate = new Date(data.birthDay);
                            let formatted = (birthDate.getMonth() + 1).toString().padStart(2, '0') + "-" +
                                            birthDate.getDate().toString().padStart(2, '0') + "-" +
                                            birthDate.getFullYear();
                            $("#detailBirthDay").text(formatted);
                        }

                        $("#detailAge").text(data.age);
                        $("#detailHomeNumber").text(data.homeNumber);
                        $("#detailOccupation").text(data.occupation);
                        $("#detailMobileNumber").text(data.mobileNumber);
                        $("#detailOfficeAddress").text(data.officeAddress);
                        $("#detailEmailAddress").text(data.emailAddress);
                        $("#detailStatus").text(data.status);
                        $("#detailNameOfSpouse").text(data.nameOfSpouse);
                        $("#detailPersonalResponsibleforAccount").text(data.personalResponsibleforAccount);
                        $("#detailRelationship").text(data.relationship);
                        $("#detailPhysicianCare").text(data.physicianCare);
                        $("#detailPhysicianName").text(data.physicianName);
                        $("#detailContactNumber").text(data.contactNumber);
                        $("#detailAvailableDay").text(data.availableDay);
                        $("#detailAvailableTime").text(data.availableTime);

                        // Extra detail fields
                        $("#detailDetailOnee").text(data.detailOnee);
                        $("#detailDetailTwoo").text(data.detailTwoo);
                        $("#detailDetailOne").text(data.detailOne);
                        $("#detailDetailTwo").text(data.detailTwo);
                        $("#detailDetailThree").text(data.detailThree);
                        $("#detailDetailFour").text(data.detailFour);
                        $("#detailDetailFive").text(data.detailFive);
                        $("#detailDetailSix").text(data.detailSix);
                        $("#detailDetailSeven").text(data.detailSeven);
                        $("#detailDetailEigth").text(data.detailEigth);

                        var detailsModal = new bootstrap.Modal(document.getElementById("detailsModal"));
                        detailsModal.show();
                    },
                    error: function () {
                        alert("Error loading details.");
                    }
                });
            });

            // ======================
            // RESCHEDULE MODAL
            // ======================
            $(".reschedule-btn").click(function (e) {
                e.preventDefault();

                var personId = $(this).data("id");
                var personName = $(this).closest('tr').find('td:first').text();

                $("#reschedulePersonId").val(personId);
                $("#reschedulePersonName").text(personName);

                $("#availableDate").empty().append('<option value="">Select date...</option>');
                $("#availableTime").empty().append('<option value="">Select time...</option>').prop('disabled', true);

                loadAvailableDates();

                var resModal = new bootstrap.Modal(document.getElementById("rescheduleModal"));
                resModal.show();
            });

            function loadAvailableDates() {
                $.ajax({
                    url: '@Url.Action("GetAvailableDates", "Reschedules")',
                    type: 'GET',
                    success: function (data) {
                        $("#availableDate").empty().append('<option value="">Select date...</option>');
                        $.each(data, function (index, item) {
                            $("#availableDate").append(
                                '<option value="' + item.value + '">' +
                                item.text + ' (' + item.availableSlots + ' slots available)</option>'
                            );
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX Error:", error);
                        alert("Error loading available dates.");
                    }
                });
            }

            // When date is selected, load time slots
            $("#availableDate").change(function () {
                var selectedDate = $(this).val();

                if (!selectedDate) {
                    $("#availableTime").empty().append('<option value="">Select time...</option>').prop('disabled', true);
                    return;
                }

                $.ajax({
                    url: '@Url.Action("GetAvailableTimeSlots", "Reschedules")',
                    type: 'GET',
                    data: { date: selectedDate },
                    success: function (data) {
                        $("#availableTime").empty().append('<option value="">Select time...</option>');

                        if (data.length === 0) {
                            $("#availableTime").append('<option value="">No available times</option>');
                            $("#availableTime").prop('disabled', true);
                        } else {
                            $.each(data, function (index, item) {
                                $("#availableTime").append(
                                    '<option value="' + item.value + '">' + item.text + '</option>'
                                );
                            });
                            $("#availableTime").prop('disabled', false);
                        }
                    },
                    error: function () {
                        alert("Error loading available time slots.");
                        $("#availableTime").prop('disabled', true);
                    }
                });
            });

            // Confirm reschedule
            $("#confirmReschedule").click(function () {
                var personId = $("#reschedulePersonId").val();
                var selectedDate = $("#availableDate").val();
                var selectedTime = $("#availableTime").val();

                if (!selectedDate || !selectedTime) {
                    alert("Please select both date and time.");
                    return;
                }

                $(this).prop('disabled', true).text('Rescheduling...');

                $.ajax({
                    url: '@Url.Action("RescheduleAppointment", "Reschedules")',
                    type: 'POST',
                    data: {
                        personId: personId,
                        newDate: selectedDate,
                        newTime: selectedTime
                    },
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            var resModal = bootstrap.Modal.getInstance(document.getElementById("rescheduleModal"));
                            resModal.hide();
                            location.reload();
                        } else {
                            alert("Reschedule failed: " + response.message);
                        }
                    },
                    error: function () {
                        alert("Error occurred while rescheduling appointment.");
                    },
                    complete: function () {
                        $("#confirmReschedule").prop('disabled', false).text('Reschedule');
                    }
                });
            });

            // Reset reschedule modal
            $('#rescheduleModal').on('hidden.bs.modal', function () {
                $("#reschedulePersonId").val('');
                $("#reschedulePersonName").text('');
                $("#availableDate").empty().append('<option value="">Select date...</option>');
                $("#availableTime").empty().append('<option value="">Select time...</option>').prop('disabled', true);
                $("#confirmReschedule").prop('disabled', false).text('Reschedule');
            });

        });
    </script>
}

